<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password | Heritage Samarth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .strength-bar { height: 4px; border-radius: 2px; transition: width 0.3s, background 0.3s; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex items-center justify-center">

    <div class="flex w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden"
         style="min-height: 560px;">

        <!-- ── Left panel ── -->
        <div class="hidden md:flex w-1/2 bg-[#2E963D] flex-col justify-between p-12 text-white relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-[#DF2027] rounded-bl-full opacity-90"></div>

            <div class="relative z-10 pt-8">
                <div class="bg-white p-4 rounded-xl inline-block mb-8 shadow-lg">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Heritage Logo" class="h-16 object-contain">
                </div>
                <h1 class="text-4xl font-extrabold tracking-tight mb-4">New<br>Password</h1>
                <p class="text-green-100 text-lg font-medium leading-relaxed">
                    Choose a strong password that you haven't used before.
                </p>

                <!-- Password tips -->
                <ul class="mt-6 space-y-2 text-green-100 text-sm">
                    <li class="flex items-center gap-2">
                        <svg class="w-4 h-4 flex-shrink-0 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        At least 8 characters
                    </li>
                    <li class="flex items-center gap-2">
                        <svg class="w-4 h-4 flex-shrink-0 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        Mix of letters and numbers
                    </li>
                    <li class="flex items-center gap-2">
                        <svg class="w-4 h-4 flex-shrink-0 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        Avoid your name or email
                    </li>
                </ul>
            </div>

            <div class="relative z-10 pb-4">
                <div class="h-1 w-12 bg-[#DF2027] rounded-full"></div>
            </div>
        </div>

        <!-- ── Right panel ── -->
        <div class="w-full md:w-1/2 p-12 flex flex-col justify-center">

            {% if success %}
            <!-- ── Success ── -->
            <div class="text-center">
                <div class="w-16 h-16 bg-green-50 border-2 border-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-8 h-8 text-[#2E963D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-3">Password Updated!</h2>
                <p class="text-gray-500 text-sm mb-8 leading-relaxed">
                    Your password has been changed successfully.<br>
                    You can now sign in with your new password.
                </p>
                <a href="{{ url_for('login') }}"
                   class="inline-block bg-[#2E963D] text-white font-bold px-8 py-3 rounded-lg
                          shadow-md hover:bg-[#247A31] transition-colors text-sm">
                    Sign In Now →
                </a>
            </div>

            {% elif token_invalid %}
            <!-- ── Invalid / expired token ── -->
            <div class="text-center">
                <div class="w-16 h-16 bg-red-50 border-2 border-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-8 h-8 text-[#DF2027]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-3">Link Expired or Invalid</h2>
                <p class="text-gray-500 text-sm mb-8 leading-relaxed">
                    This password reset link has expired or has already been used.
                    Reset links are valid for <strong>{{ expiry_minutes or 60 }} minutes</strong>.
                </p>
                <a href="{{ url_for('forgot_password') }}"
                   class="inline-block bg-[#2E963D] text-white font-bold px-8 py-3 rounded-lg
                          shadow-md hover:bg-[#247A31] transition-colors text-sm">
                    Request a New Link
                </a>
                <div class="mt-4">
                    <a href="{{ url_for('login') }}"
                       class="text-sm text-gray-400 hover:text-gray-600 font-medium">Back to Sign In</a>
                </div>
            </div>

            {% else %}
            <!-- ── Reset form ── -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Set New Password</h2>
                <p class="text-gray-500 text-sm">Choose a new password for your Samarth account.</p>
            </div>

            {% if error %}
            <div class="mb-5 bg-red-50 border-l-4 border-[#DF2027] p-4 rounded-r">
                <p class="text-sm text-[#DF2027]">{{ error }}</p>
            </div>
            {% endif %}

            <form action="{{ url_for('reset_password') }}?token={{ token }}"
                  method="POST" class="space-y-5" id="resetForm">
                <input type="hidden" name="token" value="{{ token }}">

                <!-- New password -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                    <div class="relative">
                        <input
                            type="password"
                            name="password"
                            id="pw1"
                            autofocus
                            minlength="8"
                            oninput="checkStrength(this.value)"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300
                                   focus:ring-2 focus:ring-[#2E963D] focus:border-[#2E963D]
                                   outline-none transition-all text-sm pr-11"
                            required>
                        <button type="button" onclick="toggleVisibility('pw1', this)"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400
                                   hover:text-gray-600 focus:outline-none">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7
                                         -1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <!-- Strength bar -->
                    <div class="mt-2">
                        <div class="flex gap-1 mb-1">
                            <div id="bar1" class="strength-bar flex-1 bg-gray-200"></div>
                            <div id="bar2" class="strength-bar flex-1 bg-gray-200"></div>
                            <div id="bar3" class="strength-bar flex-1 bg-gray-200"></div>
                            <div id="bar4" class="strength-bar flex-1 bg-gray-200"></div>
                        </div>
                        <p id="strength-label" class="text-[11px] text-gray-400"></p>
                    </div>
                </div>

                <!-- Confirm password -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                    <div class="relative">
                        <input
                            type="password"
                            name="password2"
                            id="pw2"
                            minlength="8"
                            oninput="checkMatch()"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300
                                   focus:ring-2 focus:ring-[#2E963D] focus:border-[#2E963D]
                                   outline-none transition-all text-sm pr-11"
                            required>
                        <button type="button" onclick="toggleVisibility('pw2', this)"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400
                                   hover:text-gray-600 focus:outline-none">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7
                                         -1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p id="match-label" class="text-[11px] mt-1 text-gray-400"></p>
                </div>

                <button type="submit" id="submitBtn"
                    class="w-full bg-[#2E963D] text-white font-bold py-3.5 rounded-lg
                           shadow-lg hover:bg-[#247A31] transition-all duration-200 text-sm">
                    Update Password
                </button>
            </form>
            {% endif %}

        </div>
    </div>

    <script>
    // ── Password strength checker ────────────────────────────
    function checkStrength(pw) {
        const bars   = [1,2,3,4].map(i => document.getElementById('bar' + i));
        const label  = document.getElementById('strength-label');
        let score    = 0;

        if (pw.length >= 8)                        score++;
        if (pw.length >= 12)                       score++;
        if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) score++;
        if (/[0-9]/.test(pw))                      score++;
        if (/[^A-Za-z0-9]/.test(pw))              score = Math.min(4, score + 1);

        const levels = [
            { color: '#EF4444', text: 'Too weak',  textColor: '#EF4444' },
            { color: '#F97316', text: 'Weak',       textColor: '#F97316' },
            { color: '#F59E0B', text: 'Fair',       textColor: '#F59E0B' },
            { color: '#2E963D', text: 'Strong',     textColor: '#2E963D' },
        ];
        const level = levels[Math.max(0, score - 1)] || levels[0];

        bars.forEach((b, i) => {
            b.style.background = i < score ? level.color : '#E5E7EB';
        });

        if (pw.length > 0) {
            label.textContent  = level.text;
            label.style.color  = level.textColor;
        } else {
            label.textContent  = '';
        }
    }

    // ── Confirm match indicator ──────────────────────────────
    function checkMatch() {
        const pw1   = document.getElementById('pw1').value;
        const pw2   = document.getElementById('pw2').value;
        const label = document.getElementById('match-label');
        if (!pw2) { label.textContent = ''; return; }
        if (pw1 === pw2) {
            label.textContent = '✓ Passwords match';
            label.style.color = '#2E963D';
        } else {
            label.textContent = '✗ Passwords do not match';
            label.style.color = '#EF4444';
        }
    }

    // ── Toggle password visibility ───────────────────────────
    function toggleVisibility(fieldId, btn) {
        const input = document.getElementById(fieldId);
        input.type  = input.type === 'password' ? 'text' : 'password';
        btn.style.color = input.type === 'text' ? '#2E963D' : '';
    }

    // ── Client-side validation before submit ─────────────────
    document.getElementById('resetForm')?.addEventListener('submit', function(e) {
        const pw1 = document.getElementById('pw1').value;
        const pw2 = document.getElementById('pw2').value;
        if (pw1 !== pw2) {
            e.preventDefault();
            document.getElementById('match-label').textContent = '✗ Passwords do not match';
            document.getElementById('match-label').style.color = '#EF4444';
        }
        if (pw1.length < 8) {
            e.preventDefault();
            alert('Password must be at least 8 characters.');
        }
    });
    </script>
</body>
</html>